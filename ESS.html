
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESS å„²èƒ½ç³»çµ±ç›£æ§</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<style>
* { box-sizing: border-box; }

body {
  font-family: 'Noto Sans TC', sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
  margin: 0; 
  padding: 40px 20px;
  min-height: 100vh;
  position: relative;
}

body::before, body::after {
  content: ''; position: fixed; border-radius: 50%; pointer-events: none;
}
body::before {
  top: -100px; right: -100px; width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(160,180,200,0.15) 0%, transparent 70%);
}
body::after {
  bottom: -150px; left: -150px; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(180,160,200,0.12) 0%, transparent 70%);
}

.container { max-width: 1280px; margin: 0 auto; position: relative; z-index: 1; }

.header {
  background: white; padding: 30px 40px; border-radius: 20px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.06); margin-bottom: 30px; border-left: 4px solid #7a8ba0;
}
.header h2 { margin: 0 0 8px 0; color: #2c3e50; font-size: 28px; font-weight: 600; font-family: 'Noto Serif TC', serif; }
.header-subtitle { font-size: 14px; color: #95a5a6; font-weight: 300; }

.debug-panel {
  background: #f8f9fa; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px;
  border-left: 3px solid #e74c3c; font-family: monospace; font-size: 12px;
  max-height: 200px; overflow-y: auto;
}
.debug-title { font-weight: 600; color: #e74c3c; margin-bottom: 8px; }
.debug-item { color: #5a6c7d; padding: 3px 0; }

.time-granularity {
  background: white; padding: 20px 35px; border-radius: 20px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.06); margin-bottom: 20px;
  display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
}
.granularity-label { font-size: 14px; font-weight: 500; color: #5a6c7d; display: flex; align-items: center; gap: 8px; }
.granularity-buttons { display: flex; gap: 10px; }
.btn-granularity {
  padding: 10px 24px; border: 2px solid #e9ecef; border-radius: 12px; background: white; color: #5a6c7d;
  cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.3s ease; font-family: 'Noto Sans TC', sans-serif;
}
.btn-granularity:hover { background: #f8f9fa; border-color: #7a8ba0; color: #2c3e50; transform: translateY(-2px); }
.btn-granularity.active { background: #7a8ba0; color: white; border-color: #7a8ba0; box-shadow: 0 4px 12px rgba(122,139,160,0.3); }

.timeline-nav {
  background: white; padding: 25px 35px; border-radius: 20px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.06); margin-bottom: 30px;
  display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
}
.date-group { display: flex; align-items: center; gap: 12px; padding: 10px 18px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef; }
.date-icon { font-size: 20px; color: #7a8ba0; }
.date-group label { font-size: 14px; font-weight: 500; color: #5a6c7d; margin: 0; }
.nav-controls { display: flex; gap: 12px; align-items: center; flex: 1; }
.progress-indicator { flex: 1; min-width: 200px; }
.progress-bar-container { width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, #7a8ba0 0%, #95aac2 100%); border-radius: 3px; transition: width 0.3s ease; }
.progress-text { font-size: 12px; color: #95a5a6; margin-top: 5px; text-align: center; }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr); 
  gap: 20px; margin-bottom: 25px;
}
.stat-card {
  background: white; padding: 25px; border-radius: 16px; box-shadow: 0 2px 15px rgba(0,0,0,0.05);
  transition: all 0.3s ease; border-top: 3px solid transparent;
  display: flex; flex-direction: column; justify-content: center;
}
.stat-card:nth-child(1) { border-top-color: #8e9eab; }
.stat-card:nth-child(2) { border-top-color: #a8b5c0; }
.stat-card:nth-child(3) { border-top-color: #c2cbd5; }
.stat-card:nth-child(4) { border-top-color: #95aac2; }
.stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 25px rgba(0,0,0,0.1); }
.stat-label { font-size: 13px; color: #95a5a6; font-weight: 400; margin-bottom: 10px; }
.stat-value { font-size: 26px; font-weight: 600; color: #2c3e50; font-family: 'Noto Serif TC', serif; }

.data-cards {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 15px; margin-bottom: 25px;
}
.data-card {
  background: white; padding: 22px; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.04);
  transition: all 0.3s ease; border-left: 3px solid #dfe6e9;
  display: flex; flex-direction: column; justify-content: center; min-height: 100px;
}
.data-card:hover { transform: translateY(-3px); box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left-color: #7a8ba0; }
.data-card.anomaly { border-left-color: #e74c3c; background: #fff5f5; }
.data-label { font-size: 12px; color: #95a5a6; font-weight: 400; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
.dot { width: 6px; height: 6px; border-radius: 50%; background: #cfd8dc; display: inline-block; }
.data-value { font-size: 18px; font-weight: 600; color: #2c3e50; font-family: 'Noto Serif TC', serif; }
.anomaly-badge { 
  display: inline-block; padding: 2px 8px; background: #e74c3c; color: white; 
  border-radius: 8px; font-size: 10px; margin-left: 5px; font-weight: 600;
}

.chart-container {
  background: white; padding: 35px; border-radius: 20px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.06); margin-bottom: 30px;
}
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f1f3f5; }
.chart-title { font-size: 18px; font-weight: 600; color: #2c3e50; font-family: 'Noto Serif TC', serif; }

button {
  padding: 10px 20px; border: 1px solid #d1d8dd; border-radius: 10px;
  background: white; color: #5a6c7d; cursor: pointer; font-weight: 500; font-size: 14px;
  transition: all 0.3s ease; font-family: 'Noto Sans TC', sans-serif;
}
button:hover:not(:disabled) { background: #f8f9fa; border-color: #7a8ba0; color: #2c3e50; transform: translateY(-1px); }
button:disabled { background: #f8f9fa; color: #cbd5e0; border-color: #e9ecef; cursor: not-allowed; }
.btn-primary { background: #7a8ba0; color: white; border-color: #7a8ba0; }
.btn-primary:hover:not(:disabled) { background: #6a7b90; border-color: #6a7b90; color: white; }

select {
  padding: 8px 14px; border-radius: 10px; border: 1px solid #d1d8dd;
  font-size: 14px; background: white; color: #5a6c7d; cursor: pointer; transition: all 0.3s ease; font-family: 'Noto Sans TC', sans-serif;
}
select:hover { border-color: #7a8ba0; }
select:focus { outline: none; border-color: #7a8ba0; box-shadow: 0 0 0 3px rgba(122,139,160,0.1); }

.trend-indicator {
  position: fixed; bottom: 30px; right: 30px; background: white;
  padding: 20px 25px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000;
}
.trend-title { font-size: 12px; color: #95a5a6; font-weight: 500; margin-bottom: 12px; text-transform: uppercase; }
.trend-value { font-size: 24px; font-weight: 600; color: #2c3e50; font-family: 'Noto Serif TC', serif; }
.trend-change { font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
.trend-up { color: #27ae60; }
.trend-down { color: #e74c3c; }
.trend-stable { color: #95a5a6; }

.hidden { display: none !important; }

@media (max-width: 1200px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .data-cards { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 768px) {
  body { padding: 20px 15px; }
  .header { padding: 20px 25px; }
  .time-granularity, .timeline-nav { flex-direction: column; align-items: stretch; }
  .nav-controls { flex-direction: column; }
  .stats-grid { grid-template-columns: 1fr; }
  .data-cards { grid-template-columns: repeat(2, 1fr); }
  .chart-container { padding: 20px; }
  .trend-indicator { position: relative; bottom: auto; right: auto; margin-bottom: 20px; }
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.5s ease; }
</style>
</head>
<body>

<div class="container">
  <div class="header fade-in">
    <h2>ESS å„²èƒ½ç³»çµ±ç›£æ§å„€è¡¨æ¿</h2>
    <div class="header-subtitle" id="lastUpdate">æ­£åœ¨é€£æ¥ Firebase...</div>
  </div>

  <!-- é™¤éŒ¯é¢æ¿ -->
  <div class="debug-panel fade-in" id="debugPanel">
    <div class="debug-title">ğŸ” ç³»çµ±é™¤éŒ¯è³‡è¨Š</div>
    <div id="debugLog"></div>
  </div>

  <div class="time-granularity fade-in">
    <div class="granularity-label"><span>ğŸ“Š</span>åˆ†æç²’åº¦</div>
    <div class="granularity-buttons">
      <button class="btn-granularity active" onclick="setMode('day', this)">æœ¬æ—¥</button>
      <button class="btn-granularity" onclick="setMode('week', this)">æœ¬é€±</button>
      <button class="btn-granularity" onclick="setMode('month', this)">æœ¬æœˆ</button>
    </div>
  </div>

  <div class="timeline-nav fade-in">
    <div class="date-group">
      <span class="date-icon">ğŸ“…</span>
      <label id="dateLabel">æ—¥æœŸ</label>
      <select id="dateSelect"></select>
    </div>
    <div class="nav-controls" id="navControls">
      <button id="prev">â† ä¸Šä¸€ç­†</button>
      <button id="next">ä¸‹ä¸€ç­† â†’</button>
      <div class="progress-indicator">
        <div class="progress-bar-container"><div id="progressBar" class="progress-bar-fill" style="width:0%"></div></div>
        <div id="progressText" class="progress-text">0 / 0</div>
      </div>
    </div>
    <button onclick="resetZoom()" class="btn-primary">é‡ç½®è¦–åœ–</button>
  </div>

  <div class="stats-grid fade-in">
    <div class="stat-card"><div class="stat-label">å¹³å‡è² è¼‰</div><div id="avgLoad" class="stat-value">--</div></div>
    <div class="stat-card"><div class="stat-label">æœ€å¤§/å°–å³°è² è¼‰</div><div id="maxLoad" class="stat-value">--</div></div>
    <div class="stat-card"><div class="stat-label">å¹³å‡SOC</div><div id="avgSOC" class="stat-value">--</div></div>
    <div class="stat-card"><div class="stat-label">å¹³å‡ESSåŠŸç‡</div><div id="avgESS" class="stat-value">--</div></div>
  </div>

  <div class="data-cards fade-in" id="dataCards">
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#546e7a"></span>æ™‚é–“</div><div id="time" class="data-value" style="font-size:16px">--</div></div>
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#2ecc71"></span>åŸå§‹è² è¼‰ (kW)</div><div id="originalLoad" class="data-value">--</div></div>
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#fbc02d"></span>èª¿ç¯€å¾Œè² è¼‰ (kW)</div><div id="adjustedLoad" class="data-value">--</div></div>
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#ff4757"></span>å¥‘ç´„å®¹é‡ (kW)</div><div id="contract" class="data-value">--</div></div>
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#00bcd4"></span>ESSåŠŸç‡ (kW)</div><div id="essPower" class="data-value">--</div></div>
    <div class="data-card"><div class="data-label"><span class="dot" style="background:#ffd93d"></span>SOC (%)</div><div id="soc" class="data-value">--</div></div>
  </div>

  <div class="chart-container fade-in">
    <div class="chart-header">
      <div class="chart-title" id="mainChartTitle">ç”¨é›»æ›²ç·š (èª¿åº¦å‰å¾Œ)</div>
    </div>
    <canvas id="mainChart" height="100"></canvas>
  </div>

  <div class="chart-container fade-in">
    <div class="chart-header">
      <div class="chart-title">ESS å„²èƒ½ç³»çµ±ç‹€æ…‹</div>
    </div>
    <canvas id="essChart" height="100"></canvas>
  </div>

  <div class="trend-indicator fade-in" id="trendIndicator">
    <div class="trend-title">ç•¶å‰è¶¨å‹¢</div>
    <div class="trend-value" id="trendValue">--</div>
    <div class="trend-change" id="trendChange"><span>--</span></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

// Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyBhCw1uuakhiPSouJoJAaZo8llJydq8-yk",
  authDomain: "esssimulation.firebaseapp.com",
  databaseURL: "https://esssimulation-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esssimulation",
  storageBucket: "esssimulation.firebasestorage.app",
  messagingSenderId: "974638774600",
  appId: "1:974638774600:web:17584ce46e3ff249131b7d",
  measurementId: "G-6Z8GBF5WQG"
};

const state = {
  data: [],
  filtered: [],
  aggregated: [],
  index: 0,
  mode: 'day',
  charts: {}
};

const colors = { 
  primary: '#4a9eff', secondary: '#fbc02d', contract: '#ff4757', 
  ess: '#00bcd4', soc: '#ffd93d', orig: '#2ecc71'
};

Chart.defaults.color = '#5a6c7d';
Chart.defaults.borderColor = '#e9ecef';
Chart.defaults.font.family = "'Noto Sans TC', sans-serif";

// é™¤éŒ¯æ—¥èªŒå‡½æ•¸
function log(message, type = 'info') {
  const debugLog = document.getElementById('debugLog');
  const timestamp = new Date().toLocaleTimeString('zh-TW');
  const color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#5a6c7d';
  debugLog.innerHTML += `<div class="debug-item" style="color:${color}">[${timestamp}] ${message}</div>`;
  debugLog.scrollTop = debugLog.scrollHeight;
  console.log(message);
}

// åˆå§‹åŒ– Firebase
log('ğŸ”Œ åˆå§‹åŒ– Firebase é€£æ¥...');
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dataRef = ref(db, "/ems_data");
log('âœ… Firebase æ‡‰ç”¨å·²åˆå§‹åŒ–');
log(`ğŸ“ ç›£è½è·¯å¾‘: /ems_data`);

onValue(dataRef, (snapshot) => {
  log('ğŸ“¡ æ”¶åˆ° Firebase æ•¸æ“šæ›´æ–°');
  
  const raw = snapshot.val();
  
  if (!raw) {
    log('âŒ éŒ¯èª¤: Firebase è¿”å›ç©ºæ•¸æ“š', 'error');
    document.getElementById('lastUpdate').innerText = "âŒ Firebase ä¸­ç„¡æ•¸æ“š,è«‹å…ˆåŸ·è¡Œ Colab ä¸Šå‚³";
    return;
  }

  log(`âœ… æˆåŠŸç²å– Firebase æ•¸æ“š`);
  log(`ğŸ“Š é ‚å±¤éµå€¼: ${Object.keys(raw).slice(0, 5).join(', ')}...`);

  state.data = [];
  let recordCount = 0;
  let dateCount = 0;
  
  // è§£æå·¢ç‹€çµæ§‹: ems_data/æ—¥æœŸ/æ™‚é–“/è¨˜éŒ„
  Object.keys(raw).forEach(dateKey => {
    const dayRecords = raw[dateKey];
    dateCount++;
    
    if (typeof dayRecords === 'object' && dayRecords !== null) {
      Object.keys(dayRecords).forEach(timeKey => {
        const record = dayRecords[timeKey];
        
        if (record && record.timestamp) {
          recordCount++;
          
          // è½‰æ› Colab æ¬„ä½åç¨±
          state.data.push({
            "è³‡æ–™æ™‚é–“": record.timestamp.replace('T', ' ').substring(0, 16),
            "èª¿åº¦å‰(åŸå§‹è² è¼‰)(kW)": Number(record.before_load) || 0,
            "èª¿ç¯€å¾Œè² è¼‰(kW)": Number(record.after_load) || 0,
            "å¥‘ç´„å®¹é‡ (kW)": Number(record.contract_capacity) || 500,
            "ESSåŠŸç‡(kW)": Number(record.ess_power) || 0,
            "SOC(%)": Number(record.soc) || 0,
            "is_anomaly": Number(record.is_anomaly) || 0
          });
        }
      });
    }
  });

  log(`âœ… è§£æå®Œæˆ: ${dateCount} å¤©, ${recordCount} ç­†è¨˜éŒ„`, 'success');

  if (state.data.length === 0) {
    log('âŒ éŒ¯èª¤: è§£æå¾Œç„¡æœ‰æ•ˆæ•¸æ“š', 'error');
    document.getElementById('lastUpdate').innerText = "âŒ æ•¸æ“šæ ¼å¼éŒ¯èª¤";
    return;
  }

  state.data.sort((a,b) => new Date(a["è³‡æ–™æ™‚é–“"]) - new Date(b["è³‡æ–™æ™‚é–“"]));
  log(`ğŸ”„ æ•¸æ“šå·²æ’åº,æ™‚é–“ç¯„åœ: ${state.data[0]["è³‡æ–™æ™‚é–“"]} ~ ${state.data[state.data.length-1]["è³‡æ–™æ™‚é–“"]}`);
  
  updateLastUpdate();
  initView();
  
  log(`ğŸ‰ åˆå§‹åŒ–å®Œæˆ!`, 'success');
  
  // 3ç§’å¾Œéš±è—é™¤éŒ¯é¢æ¿
  setTimeout(() => {
    document.getElementById('debugPanel').style.display = 'none';
  }, 3000);
  
}, (error) => {
  log(`âŒ Firebase éŒ¯èª¤: ${error.message}`, 'error');
  document.getElementById('lastUpdate').innerText = `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`;
});

function updateLastUpdate() {
  const time = `âœ… æ›´æ–°æ™‚é–“: ${new Date().toLocaleString('zh-TW')} | æ•¸æ“šç­†æ•¸: ${state.data.length}`;
  document.getElementById('lastUpdate').innerText = time;
}

window.setMode = (mode, btn) => {
  state.mode = mode;
  document.querySelectorAll('.btn-granularity').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  initView();
};

function initView() {
  const select = document.getElementById('dateSelect');
  
  const dates = [...new Set(state.data.map(d => {
    const full = (d["è³‡æ–™æ™‚é–“"]||"").split(" ")[0];
    if (state.mode === 'month') return full.substring(0, 7);
    if (state.mode === 'week') return getWeekIdentifier(new Date(full));
    return full;
  }))].filter(d => d).sort();

  if (dates.length === 0) {
    log('âš ï¸ è­¦å‘Š: ç„¡å¯ç”¨æ—¥æœŸ', 'error');
    return;
  }

  const currentVal = select.value;
  select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
  if(currentVal && dates.includes(currentVal)) select.value = currentVal;
  else if(dates.length > 0) select.value = dates[dates.length - 1];

  select.onchange = () => applyFilter();
  applyFilter();
}

function getWeekIdentifier(date) {
  const start = new Date(date.getFullYear(), 0, 1);
  const days = Math.floor((date - start) / 86400000);
  const week = Math.ceil((days + start.getDay() + 1) / 7);
  return `${date.getFullYear()}-W${String(week).padStart(2,'0')}`;
}

function applyFilter() {
  const select = document.getElementById('dateSelect');
  const val = select.value;

  if (state.mode === 'day') {
    state.filtered = state.data.filter(d => (d["è³‡æ–™æ™‚é–“"]||"").startsWith(val));
    state.aggregated = [];
    state.index = 0;
  } else {
    const rawFiltered = state.data.filter(d => {
       const dStr = (d["è³‡æ–™æ™‚é–“"]||"").split(" ")[0];
       if(state.mode === 'week') return getWeekIdentifier(new Date(dStr)) === val;
       return dStr.startsWith(val);
    });
    state.filtered = rawFiltered; 
    state.aggregated = aggregateData(rawFiltered);
  }

  updateStats();
  updateUI();
  renderCharts();
}

function aggregateData(data) {
  const map = {};
  data.forEach(d => {
    const date = (d["è³‡æ–™æ™‚é–“"]||"").split(" ")[0];
    if(!map[date]) map[date] = { count:0, sumL:0, maxL:0, sumS:0, sumE:0, sumOrig:0, maxOrig:0 };
    
    const adj = Number(d["èª¿ç¯€å¾Œè² è¼‰(kW)"])||0;
    const orig = Number(d["èª¿åº¦å‰(åŸå§‹è² è¼‰)(kW)"])||0;
    const s = Number(d["SOC(%)"])||0;
    const e = Number(d["ESSåŠŸç‡(kW)"])||0;
    
    map[date].sumL += adj;
    map[date].maxL = Math.max(map[date].maxL, adj);
    map[date].sumOrig += orig;
    map[date].maxOrig = Math.max(map[date].maxOrig, orig);
    map[date].sumS += s;
    map[date].sumE += e;
    map[date].count++;
  });

  return Object.keys(map).sort().map(k => {
    const o = map[k];
    return {
      date: k,
      avgLoad: (o.sumL/o.count).toFixed(2),
      peakLoad: o.maxOrig.toFixed(2),
      avgSoc: (o.sumS/o.count).toFixed(2),
      avgEss: (o.sumE/o.count).toFixed(2)
    };
  });
}

function updateStats() {
  const isDay = state.mode === 'day';
  const source = isDay ? state.filtered : state.aggregated;
  
  if(source.length === 0) {
    document.getElementById('avgLoad').innerText = "-- kW";
    document.getElementById('maxLoad').innerText = "-- kW";
    document.getElementById('avgSOC').innerText = "-- %";
    document.getElementById('avgESS').innerText = "-- kW";
    return;
  }

  let avgL, maxL, avgS, avgE;
  if(isDay) {
    const loads = source.map(d=>Number(d["èª¿ç¯€å¾Œè² è¼‰(kW)"])||0);
    const origs = source.map(d=>Number(d["èª¿åº¦å‰(åŸå§‹è² è¼‰)(kW)"])||0);
    const socs = source.map(d=>Number(d["SOC(%)"])||0);
    const esss = source.map(d=>Number(d["ESSåŠŸç‡(kW)"])||0);
    
    avgL = (loads.reduce((a,b)=>a+b,0)/loads.length).toFixed(2);
    maxL = Math.max(...origs).toFixed(2);
    avgS = (socs.reduce((a,b)=>a+b,0)/socs.length).toFixed(2);
    avgE = (esss.reduce((a,b)=>a+b,0)/esss.length).toFixed(2);
  } else {
    const avgs = source.map(d=>Number(d.avgLoad));
    const peaks = source.map(d=>Number(d.peakLoad));
    const socs = source.map(d=>Number(d.avgSoc));
    const esss = source.map(d=>Number(d.avgEss));
    
    avgL = (avgs.reduce((a,b)=>a+b,0)/avgs.length).toFixed(2);
    maxL = Math.max(...peaks).toFixed(2);
    avgS = (socs.reduce((a,b)=>a+b,0)/socs.length).toFixed(2);
    avgE = (esss.reduce((a,b)=>a+b,0)/esss.length).toFixed(2);
  }
  
  document.getElementById('avgLoad').innerText = avgL + " kW";
  document.getElementById('maxLoad').innerText = maxL + " kW";
  document.getElementById('avgSOC').innerText = avgS + " %";
  document.getElementById('avgESS').innerText = avgE + " kW";
}

function updateUI() {
  const isDay = state.mode === 'day';
  
  const navControls = document.getElementById('navControls');
  const dataCards = document.getElementById('dataCards');
  const trend = document.getElementById('trendIndicator');
  
  if(isDay) {
    navControls.classList.remove('hidden');
    dataCards.classList.remove('hidden');
    trend.classList.remove('hidden');
  } else {
    navControls.classList.add('hidden');
    dataCards.classList.add('hidden');
    trend.classList.add('hidden');
  }

  document.getElementById('dateLabel').innerText = isDay ? 'æ—¥æœŸ' : (state.mode === 'week' ? 'é€±æ¬¡' : 'æœˆä»½');
  document.getElementById('mainChartTitle').innerText = isDay ? 'ç”¨é›»æ›²ç·š (èª¿åº¦å‰å¾Œ)' : 'æ¯æ—¥è² è¼‰åˆ†æ';

  if(isDay && state.filtered.length > 0) {
    updateCard(state.filtered[state.index]);
    updateTrend();
  }
}

function updateCard(d) {
  const progress = ((state.index + 1) / state.filtered.length) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
  document.getElementById('progressText').innerText = `${state.index + 1} / ${state.filtered.length}`;

  document.getElementById('time').innerText = d["è³‡æ–™æ™‚é–“"];
  document.getElementById('originalLoad').innerText = d["èª¿åº¦å‰(åŸå§‹è² è¼‰)(kW)"];
  document.getElementById('adjustedLoad').innerText = d["èª¿ç¯€å¾Œè² è¼‰(kW)"];
  document.getElementById('contract').innerText = d["å¥‘ç´„å®¹é‡ (kW)"];
  document.getElementById('essPower').innerText = d["ESSåŠŸç‡(kW)"];
  document.getElementById('soc').innerText = d["SOC(%)"];
  
  // ç•°å¸¸æç¤º
  const cards = document.querySelectorAll('.data-card');
  cards.forEach(c => c.classList.remove('anomaly'));
  
  const badge = document.querySelector('.anomaly-badge');
  if(badge) badge.remove();
  
  if(d.is_anomaly === 1) {
    cards.forEach(c => c.classList.add('anomaly'));
    const timeEl = document.getElementById('time');
    if(!timeEl.querySelector('.anomaly-badge')) {
      timeEl.innerHTML += '<span class="anomaly-badge">ç•°å¸¸</span>';
    }
  }
}

function updateTrend() {
  if(state.index === 0) {
    document.getElementById('trendValue').innerText = "--";
    document.getElementById('trendChange').innerHTML = '<span class="trend-stable">--</span>';
    return;
  }
  
  const cur = Number(state.filtered[state.index]["èª¿ç¯€å¾Œè² è¼‰(kW)"]);
  const prev = Number(state.filtered[state.index-1]["èª¿ç¯€å¾Œè² è¼‰(kW)"]);
  
  const diff = cur - prev;
  const pct = prev ? ((diff/prev)*100).toFixed(2) : 0;
  
  document.getElementById('trendValue').innerText = cur.toFixed(2) + " kW";
  let cls = 'trend-stable', sym = 'â†’';
  if(diff > 0) { cls = 'trend-up'; sym = 'â†‘'; }
  else if(diff < 0) { cls = 'trend-down'; sym = 'â†“'; }
  
  document.getElementById('trendChange').innerHTML = `<span class="${cls}">${sym} ${Math.abs(pct)}%</span>`;
}

function renderCharts() {
  if(state.charts.c1) state.charts.c1.destroy();
  if(state.charts.c2) state.charts.c2.destroy();

  const ctx1 = document.getElementById('mainChart');
  const ctx2 = document.getElementById('essChart');

  const commonOpt = {
    responsive: true, maintainAspectRatio: true,
    animation: { duration: 0 },
    interaction: { mode: 'index', intersect: false }, 
    plugins: {
      zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } },
      legend: { position: 'top' },
      tooltip: { mode: 'index', intersect: false }
    },
    onClick: (e, elements) => {
      if (elements.length > 0 && state.mode === 'day') {
        state.index = elements[0].index;
        updateCard(state.filtered[state.index]);
        updateTrend();
      }
    }
  };

  if(state.mode === 'day') {
    const labels = state.filtered.map(d=>d["è³‡æ–™æ™‚é–“"]);
    const orig = state.filtered.map(d=>Number(d["èª¿åº¦å‰(åŸå§‹è² è¼‰)(kW)"]));
    const adj = state.filtered.map(d=>Number(d["èª¿ç¯€å¾Œè² è¼‰(kW)"]));
    const contract = state.filtered.map(d=>Number(d["å¥‘ç´„å®¹é‡ (kW)"]));
    const ess = state.filtered.map(d=>Number(d["ESSåŠŸç‡(kW)"]));
    const soc = state.filtered.map(d=>Number(d["SOC(%)"]));
    
    // æ¨™è¨˜ç•°å¸¸é»
    const anomalyColors = state.filtered.map(d => d.is_anomaly === 1 ? 'rgba(231, 76, 60, 0.8)' : colors.secondary);

    state.charts.c1 = new Chart(ctx1, {
      type: 'line',
      data: { labels, datasets: [
        { label: 'åŸå§‹è² è¼‰', data: orig, borderColor: colors.orig, pointRadius:0, borderWidth: 2 },
        { 
          label: 'èª¿ç¯€å¾Œè² è¼‰', 
          data: adj, 
          borderColor: colors.secondary, 
          backgroundColor: anomalyColors,
          pointRadius: state.filtered.map(d => d.is_anomaly === 1 ? 5 : 0),
          pointStyle: 'circle',
          borderWidth: 2.5 
        },
        { label: 'å¥‘ç´„å®¹é‡', data: contract, borderColor: colors.contract, borderDash:[5,5], pointRadius:0, borderWidth: 2 }
      ]},
      options: commonOpt
    });

    state.charts.c2 = new Chart(ctx2, {
      type: 'line',
      data: { labels, datasets: [
        { label: 'ESSåŠŸç‡', data: ess, borderColor: colors.ess, pointRadius:0, borderWidth: 2 },
        { label: 'SOC(%)', data: soc, borderColor: colors.soc, yAxisID: 'y1', pointRadius:0, borderWidth: 2 }
      ]},
      options: { 
        ...commonOpt, 
        scales: { 
          y: {
            title: { display: true, text: 'ESSåŠŸç‡ (kW)' },
            grid: { color: (context) => context.tick.value === 0 ? '#5a6c7d' : '#e9ecef' }
          },
          y1: { 
            position: 'right', 
            min: 0, 
            max: 100,
            title: { display: true, text: 'SOC (%)' }
          } 
        } 
      }
    });
  } else {
    const labels = state.aggregated.map(d=>d.date);
    state.charts.c1 = new Chart(ctx1, {
      type: 'bar',
      data: { labels, datasets: [
        { label: 'å¹³å‡è² è¼‰', data: state.aggregated.map(d=>d.avgLoad), backgroundColor: colors.primary },
        { label: 'å°–å³°è² è¼‰', data: state.aggregated.map(d=>d.peakLoad), backgroundColor: colors.secondary }
      ]},
      options: commonOpt
    });
    state.charts.c2 = new Chart(ctx2, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'å¹³å‡ SOC (%)', data: state.aggregated.map(d=>d.avgSoc), backgroundColor: colors.soc }]},
      options: { ...commonOpt, scales: { y: { min:0, max:100 } } }
    });
  }
}

document.getElementById('prev').onclick = () => {
  if(state.index > 0) { 
    state.index--; 
    updateCard(state.filtered[state.index]); 
    updateTrend(); 
  }
};

document.getElementById('next').onclick = () => {
  if(state.index < state.filtered.length-1) { 
    state.index++; 
    updateCard(state.filtered[state.index]); 
    updateTrend(); 
  }
};

window.resetZoom = () => {
  if(state.charts.c1) state.charts.c1.resetZoom();
  if(state.charts.c2) state.charts.c2.resetZoom();
};
</script>
</body>
</html>
